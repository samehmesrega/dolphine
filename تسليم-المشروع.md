# تسليم مشروع دولفين (Dolphine) — وثيقة المشروع الكاملة

**آخر تحديث:** 2025-02-14

---

## تعليمات للفريق القادم

- **اقرأ هذا الملف قبل تنفيذ أي خطوة جديدة.**
- **حدّث هذا الملف بعد كل جلسة عمل أو محادثة** (ما تم تنفيذه، ما تم مناقشته، أي تغييرات في الهيكل أو التوثيق).
- هذا الملف يلخّص كل ما يلزم لتسليم المشروع لشركة برمجيات أخرى للمتابعة أو التطوير.

---

## 1. نظرة عامة على المشروع

- **الاسم:** دولفين (Dolphine) — نظام إدارة الليدز والمبيعات.
- **الوصف:** تطبيق ويب لإدارة الليدز، العملاء، الطلبات، المنتجات، الشيفتات، والتكامل مع ووردبريس/ووكومرس ونماذج الموقع (الفورمس).
- **المكونات الرئيسية:**
  - **Backend:** API بـ Node.js + Express + Prisma + PostgreSQL.
  - **Frontend:** واجهة مستخدم React + TypeScript + Vite + Tailwind.
  - **بلجن ووردبريس:** Dolphine — لربط فورم معيّنة (Forminator, Contact Form 7, Elementor) بتطبيق دولفين عبر ويب هوك.

---

## 2. هيكل المشروع (Structure)

```
dolphin/
├── backend/                 # API (Node.js + Express + Prisma)
│   ├── prisma/
│   │   ├── schema.prisma    # نموذج قاعدة البيانات
│   │   ├── seed.ts          # بيانات أولية (أدوار، مستخدم أدمن، حالات الليد)
│   │   └── integration_settings_table.sql
│   ├── src/
│   │   ├── config/          # إعدادات (JWT, upload, woocommerce)
│   │   ├── middleware/      # auth
│   │   ├── routes/          # auth, leads, orders, customers, products, dashboard, shifts, woocommerce, form-connections, webhooks, users, lead-statuses
│   │   ├── services/        # woocommerce, roundRobin
│   │   ├── db.ts
│   │   ├── index.ts
│   │   └── utils/           # phone (normalize)
│   ├── .env / .env.example
│   └── package.json
├── frontend/                # React + Vite + Tailwind
│   ├── src/
│   │   ├── components/      # Layout, Sidebar
│   │   ├── context/         # AuthContext
│   │   ├── pages/           # Login, Dashboard, Leads, Customers, Orders, Products, Shifts, Users, Integrations, Reports, etc.
│   │   └── services/        # api (axios)
│   ├── vite.config.ts       # proxy /api → 3001, allowedHosts لـ ngrok
│   └── package.json
├── wordpress-plugin/        # بلجن Dolphine لووردبريس
│   ├── dolphine.php         # الملف الرئيسي للبلجن
│   └── README.md
├── خطوات-ربط-الفورم.md
└── تسليم-المشروع.md        # هذا الملف
```

---

## 3. التقنيات المستخدمة

| المكون      | التقنية |
|------------|----------|
| Backend    | Node.js, Express, TypeScript, Prisma, PostgreSQL, bcrypt, JWT, zod, multer, libphonenumber-js |
| Frontend   | React 18, TypeScript, Vite, Tailwind CSS, React Router, TanStack Query, Axios |
| قاعدة البيانات | PostgreSQL (مثلاً Neon) |
| بلجن ووردبريس | PHP، متوافق مع Forminator, Contact Form 7, Elementor Forms |

---

## 4. قاعدة البيانات (ملخص الـ Schema)

- **User, Role, Permission, RolePermission, UserPermission** — المستخدمون والأدوار والصلاحيات.
- **Customer** — العملاء (حسب رقم الهاتف)، مرتبطون بـ Lead و Order.
- **Lead, LeadStatus** — الليدز وحالاتها.
- **Communication** — تواصل مع الليد (واتساب، مكالمة، إلخ).
- **ResponseRequest** — طلبات رد.
- **Product, ProductInterest** — المنتجات (من ووكومرس) واهتمامات الليد بالمنتجات.
- **Order, OrderItem** — الطلبات وعناصر الطلب.
- **Shift, ShiftMember** — الشيفتات والأعضاء (للتوزيع Round Robin).
- **FormConnection** — اتصالات النماذج (ووردبريس → ويب هوك)، كل اتصال له token.
- **IntegrationSetting** — إعدادات ووكومرس من الواجهة (baseUrl, consumerKey, consumerSecret).
- **AuditLog, Notification** — التدقيق والإشعارات (جداول موجودة، تفعيل كامل لاحقاً).
- **CustomFieldConfig** — إعدادات حقول مخصصة.

---

## 5. واجهات الـ API (ملخص)

جميع المسارات تحت `/api` ما عدا الويب هوك (بدون مصادقة).

| المسار | الطريقة | الوصف |
|--------|---------|--------|
| `/api/auth/login` | POST | تسجيل الدخول |
| `/api/webhooks/leads/:token` | POST | استقبال ليد من ووردبريس (بدون مصادقة) |
| `/api/lead-statuses` | GET, POST, DELETE | حالات الليد |
| `/api/leads` | GET, POST | قائمة وإنشاء ليد |
| `/api/leads/:id` | GET, PATCH, DELETE | تفاصيل، تحديث، حذف |
| `/api/leads/:id/communications` | POST | إضافة تواصل |
| `/api/leads/:id/product-interests` | GET, POST, DELETE | اهتمامات المنتجات |
| `/api/customers` | GET | قائمة العملاء |
| `/api/customers/:id` | GET | تفاصيل عميل |
| `/api/orders` | GET, POST | قائمة وإنشاء طلب |
| `/api/orders/:id` | GET, PATCH | تفاصيل، تحديث |
| `/api/orders/:id/push-to-woocommerce` | POST | رفع الطلب إلى ووكومرس |
| `/api/products` | GET | منتجات نشطة |
| `/api/products/hidden` | GET | منتجات غير نشطة |
| `/api/products/:id/hide` | POST, PATCH | إخفاء منتج |
| `/api/products/:id/restore` | POST, PATCH | استعادة منتج |
| `/api/dashboard/stats` | GET | إحصائيات الداشبورد |
| `/api/dashboard/leads-over-time` | GET | ليدز خلال فترة (query: days، groupBy=day\|week) — للرسوم البيانية |
| `/api/dashboard/orders-by-status` | GET | توزيع الطلبات حسب الحالة — للرسم الدائري/الأعمدة |
| `/api/shifts` | GET, POST, PATCH, DELETE | الشيفتات |
| `/api/shifts/:id/members` | POST, DELETE | أعضاء الشيفت |
| `/api/users` | GET | قائمة المستخدمين |
| `/api/woocommerce/status` | GET | حالة ووكومرس |
| `/api/woocommerce/config` | GET, POST | إعدادات ووكومرس (من الواجهة) |
| `/api/woocommerce/sync-products` | POST | مزامنة المنتجات من ووكومرس |
| `/api/form-connections` | GET, POST, DELETE | اتصالات النماذج (ويب هوك لكل فورم) |

---

## 6. متغيرات البيئة (Backend)

في `backend/.env` (انظر `.env.example`):

- `PORT` — منفذ الـ API (مثلاً 3001).
- `DATABASE_URL` — رابط اتصال PostgreSQL.
- `JWT_SECRET`, `JWT_EXPIRES_IN`, `JWT_REFRESH_EXPIRES_IN` — للمصادقة.
- `LEADS_API_KEY` — اختياري لاستقبال ليدز.
- `WOOCOMMERCE_BASE_URL`, `WOOCOMMERCE_CONSUMER_KEY`, `WOOCOMMERCE_CONSUMER_SECRET` — ووكومرس (يمكن أيضاً ضبطها من واجهة الربط).
- `UPLOAD_DIR`, `MAX_FILE_SIZE_MB` — رفع الملفات.

---

## 7. ما تم تنفيذه (من المحادثات والجلسات)

- إنشاء المشروع (Backend + Frontend + Prisma + PostgreSQL).
- المصادقة (JWT)، المستخدمون والأدوار، Seed (مستخدم أدمن: admin@dolphin.local / admin123).
- الليدز: قائمة، إضافة، تفاصيل، تواصل، اهتمامات منتجات، حذف، تصدير CSV، فلتر وترتيب.
- العملاء: قائمة وتفاصيل (مرتبط بالليدز والطلبات).
- الطلبات: إنشاء من الليد، رفع صورة، قائمة، تفاصيل، تأكيد/رفض من الحسابات، رفع إلى ووكومرس بعد التأكيد.
- الداشبورد والتقارير الأساسية.
- المنتجات: مزامنة من ووكومرس، قائمة، إخفاء/استعادة (منتجات نشطة / غير نشطة) — **زر الإخفاء أُبلغ بعدم عمله لدى المستخدم، قد يحتاج مراجعة**.
- الشيفتات: إدارة شيفتات وأعضاء، Round Robin لتوزيع الليدز تلقائياً عند الإنشاء.
- صفحة الحسابات (المستخدمين) وصفحة الربط (Integrations).
- **الربط مع ووكومرس:**
  - إعدادات من الواجهة (رابط الموقع، Consumer Key، Consumer Secret) مخزنة في `IntegrationSetting`.
  - مزامنة المنتجات، رفع الطلب إلى ووكومرس بعد تأكيد الحسابات.
- **ربط النماذج (ووردبريس):**
  - في التطبيق: إنشاء اتصال (اسم + shortcode اختياري) → الحصول على رابط ويب هوك (token).
  - ويب هوك: `POST /api/webhooks/leads/:token` يستقبل JSON (name, phone, email, your-name, your-phone, إلخ) وينشئ ليد مع Round Robin.
  - بلجن Dolphine لووردبريس: ربط **فورم معيّنة** فقط (Forminator, Contact Form 7, Elementor)، كل فورم برابط ويب هوك خاص.
- دعم **Forminator** في البلجن (hooks: forminator_form_after_handle_submit, forminator_form_after_save_entry)، تحويل إدخال Forminator إلى payload مع your-name, your-phone, your-email.
- تحسين رسائل الخطأ في تسجيل الدخول وصفحة الربط.
- إضافة `allowedHosts` في Vite لاستخدام ngrok مع الفرونت.
- إضافة logging في ويب هوك الليدز ودعم `express.urlencoded` وتحسين التعرف على حقل الهاتف.
- ملفات توثيق: خطوات ربط الفورم، وربط البلجن.

---

## 8. المتبقي للتنفيذ (حسب النقاشات السابقة)

- **إدارة المستخدمين:** إضافة/تعديل/تعطيل مستخدم من الواجهة والـ API (حالياً GET فقط).
- **تفعيل الأدوار والصلاحيات:** ربط Permissions و RolePermissions بالقوائم والأزرار وربما middleware صلاحيات.
- **نظام الإشعارات:** استخدام جدول Notification، إنشاء إشعارات (مثلاً عند طلب رد أو طلب بانتظار الحسابات)، وواجهة (أيقونة جرس + قائمة).
- **التدقيق (Audit Log):** تسجيل التغييرات من نقاط رئيسية (تعديل ليد، تأكيد/رفض طلب، مستخدمين)، وواجهة لعرض السجل مع ترقيم/فلاتر.
- **التقارير المتقدمة والرسوم البيانية:** تقارير حسب الفترة/المصدر، ورسوم بيانية في الداشبورد (ليدز خلال الشهر، توزيع حالات الطلبات).
- **إصلاح/مراجعة:** زر إخفاء المنتج (تحويل لغير نشط) — أُبلغ بعدم عمله؛ قد يحتاج تتبع السبب (طلب الـ API أو تحديث الواجهة).
- **رفع المشروع أونلاين:** نشر Backend و Frontend على استضافة (مثلاً Render) واستخدام رابط عام للويب هوك بدلاً من localhost/ngrok.

---

## 9. بلجن ووردبريس Dolphine

- **الموقع:** `dolphin/wordpress-plugin/dolphine.php`.
- **الوظيفة:** ربط فورم معيّنة (واحدة أو أكثر) برابط ويب هوك من تطبيق دولفين؛ عند الإرسال تُرسل البيانات إلى الويب هوك فقط للفورم المربوطة.
- **الإعداد في ووردبريس:** الإعدادات ← Dolphine → إضافة ربط: نوع الفورم (Forminator / CF7 / Elementor)، اختيار الفورم، لصق رابط الويب هوك.
- **الحصول على رابط الويب هوك:** من تطبيق دولفين ← الربط (ووردبريس / ووكومرس) ← نماذج ووردبريس → إضافة اتصال → نسخ الرابط.
- **ملاحظة:** رابط الويب هوك يجب أن يكون عنواناً **عاماً** (استضافة أو ngrok)، وليس localhost، حتى يستطيع سيرفر ووردبريس إرسال الطلب.

---

## 10. التشغيل والتسليم

- **تشغيل محلي:**
  - Backend: `cd backend && npm run dev` (منفذ 3001).
  - Frontend: `cd frontend && npm run dev` (منفذ 3000، proxy لـ /api إلى 3001).
  - قاعدة البيانات: تشغيل PostgreSQL وضبط `DATABASE_URL`، ثم `npx prisma db push` أو `npx prisma migrate deploy`، ثم `npx tsx prisma/seed.ts`.
- **للويب هوك من ووردبريس أثناء التطوير:** استخدام ngrok على منفذ الـ Backend (3001) أو على 3000 مع الـ proxy، ووضع رابط ngrok في بلجن Dolphine. في `vite.config.ts` تم إضافة `allowedHosts` لدومين ngrok عند الحاجة.
- **تسليم لشركة أخرى:** تسليم المستودع كاملاً + هذا الملف + أي ملفات `.env.example` وعدم تسريب `.env` الفعلي. توثيق متطلبات التشغيل (Node، PostgreSQL، ووردبريس مع Forminator/CF7 إن لزم).

---

## 11. ملاحظات معروفة

- زر «إخفاء» المنتج (تحويل لغير نشط): تم تنفيذه (API + واجهة) لكن المستخدم أبلغ أن الزر لا يعمل؛ قد يكون مرتبطاً بسلوك الواجهة أو الـ API ويحتاج تتبعاً.
- الليد من Forminator قد لا يظهر إذا كان الـ Backend غير متاح من النت (localhost فقط) أو إذا حقل الهاتف غير مرسل أو باسم غير مدعوم؛ تمت إضافة logging في الويب هوك لتسهيل التشخيص.

---

*يُحدّث هذا الملف بعد كل محادثة/جلسة تنفيذ وفق تعليمات المشروع.*
